<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Farmacia App v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app" class="w-full h-full max-w-full">
        <div id="loginView" class="hidden">
            <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm mx-auto mt-20">
                <h2 class="text-3xl font-bold text-center text-blue-800 mb-6">Ingreso al Sistema</h2>
                <form id="loginForm" class="space-y-4">
                    <input type="email" id="email" placeholder="Correo Electrónico" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" required>
                    <input type="password" id="password" placeholder="Contraseña" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500" required>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Ingresar</button>
                </form>
                <p id="errorMsg" class="text-red-500 text-center mt-4"></p>
                <div class="text-center mt-4">
                    <a href="#" id="showRegister" class="text-sm text-blue-600 hover:underline">¿No tienes cuenta? Regístrate</a>
                </div>
            </div>
        </div>

        <div id="dashboardView" class="hidden min-h-screen w-full">
            <header class="bg-blue-800 text-white p-4 shadow-lg flex flex-col sm:flex-row items-center justify-between">
                <h1 class="text-2xl font-bold flex items-center gap-2">📦 Sistema de Farmacia <span id="userName" class="text-base font-normal"></span></h1>
                <button id="logoutBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Salir</button>
            </header>

            <main class="p-4 sm:p-8 max-w-7xl mx-auto space-y-8">
                <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-blue-700">Lotes de Inventario</h2>
                        <button id="addLoteBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">📦 Añadir Lote (Compra)</button>
                    </div>
                    <div class="overflow-x-auto rounded-lg border">
                        <table class="min-w-full divide-y">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Medicamento</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proveedor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cant. Actual</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vencimiento</th>
                                </tr>
                            </thead>
                            <tbody id="lotesTableBody" class="bg-white divide-y"></tbody>
                        </table>
                    </div>
                </section>
                
                <section class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-blue-700">Ventas</h2>
                        <button id="addSaleBtn" class="bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">🛒 Nueva Venta</button>
                    </div>
                    <div class="overflow-x-auto rounded-lg border">
                        <table class="min-w-full divide-y">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Atendido por</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody" class="bg-white divide-y"></tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <div id="appModal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-lg w-full transform transition-all scale-95 opacity-0 duration-300" id="modalContent">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-2xl font-bold text-blue-700"></h3>
                <button onclick="closeModal()" class="text-gray-500 text-3xl hover:text-gray-800">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

<script>
// ============================================================================
// 🔹 1. CONFIGURACIÓN E INICIALIZACIÓN
// ============================================================================
const SUPABASE_URL = 'https://ccfgclymyeciqbgrdfuf.supabase.co'; 
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZmdjbHlteWVjaXFiZ3JkZnVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NTcwODQsImV4cCI6MjA3MjQzMzA4NH0.hN5kiIxFa4FAzsI4UWJGcKQyTTu30dk6M6ybN-PQ2GM';
const API_URL = 'https://farmacia-269414280318.europe-west1.run.app'; // La que ya tenías

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let appState = { session: null };

// --- DOM Elements ---
const loginView = document.getElementById('loginView');
const dashboardView = document.getElementById('dashboardView');
const loginForm = document.getElementById('loginForm');
const errorMsg = document.getElementById('errorMsg');
const userNameDisplay = document.getElementById('userName');
const logoutBtn = document.getElementById('logoutBtn');
const lotesTableBody = document.getElementById('lotesTableBody');
const salesTableBody = document.getElementById('salesTableBody');
const addLoteBtn = document.getElementById('addLoteBtn');
const addSaleBtn = document.getElementById('addSaleBtn');
const showRegisterBtn = document.getElementById('showRegister');

// ============================================================================
// 🔹 2. HELPER FUNCTIONS (UTILITIES & API)
// ============================================================================
async function apiFetch(endpoint, options = {}) {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) throw new Error("No estás autenticado.");
    const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` };
    const response = await fetch(`${API_URL}${endpoint}`, { ...options, headers: { ...headers, ...options.headers } });
    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Error de la API: ${errorText}`);
    }
    const contentType = response.headers.get("content-type");
    if (contentType?.includes("application/json")) return response.json();
    return {};
}

const appModal = document.getElementById('appModal');
const modalContent = document.getElementById('modalContent');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');

const showModal = () => {
    appModal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
};

const closeModal = () => {
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
        appModal.classList.add('hidden');
        modalBody.innerHTML = '';
    }, 300);
};

const showFormModal = (title, formHtml, onSubmit) => {
    modalTitle.textContent = title;
    modalBody.innerHTML = '';
    const form = document.createElement('form');
    form.className = 'space-y-4';
    form.innerHTML = formHtml;
    form.onsubmit = (e) => {
        e.preventDefault();
        onSubmit(e);
    };
    modalBody.appendChild(form);
    showModal();
};

window.closeModal = closeModal;

// ============================================================================
// 🔹 3. AUTHENTICATION
// ============================================================================
async function handleLogin(e) {
    e.preventDefault();
    errorMsg.textContent = '';
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if (error) errorMsg.textContent = 'Credenciales incorrectas.';
}

async function handleSignUp(e) {
    const form = e.target;
    const formData = new FormData(form);
    const { email, password, nombre, apellido, dni } = Object.fromEntries(formData.entries());
    const { error } = await supabaseClient.auth.signUp({ email, password, options: { data: { nombre, apellido, dni } } });
    closeModal();
    if (error) alert(`Error en el registro: ${error.message}`);
    else alert('Registro Exitoso. Revisa tu correo para la confirmación.');
}

async function handleLogout() {
    await supabaseClient.auth.signOut();
}

function showRegisterForm() {
    const formHtml = `
        <input type="text" name="nombre" placeholder="Nombre" class="w-full px-4 py-2 border-2 rounded-lg" required>
        <input type="text" name="apellido" placeholder="Apellido" class="w-full px-4 py-2 border-2 rounded-lg" required>
        <input type="text" name="dni" placeholder="DNI" class="w-full px-4 py-2 border-2 rounded-lg" required>
        <input type="email" name="email" placeholder="Correo Electrónico" class="w-full px-4 py-2 border-2 rounded-lg" required>
        <input type="password" name="password" placeholder="Contraseña (mín. 6 caracteres)" class="w-full px-4 py-2 border-2 rounded-lg" required>
        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Registrar</button>
    `;
    showFormModal("Registro de Nuevo Usuario", formHtml, handleSignUp);
}

// ============================================================================
// 🔹 4. UI & DATA RENDERING
// ============================================================================
async function updateDashboard() {
    if (!appState.session) {
        loginView.classList.remove('hidden');
        dashboardView.classList.add('hidden');
        return;
    }
    loginView.classList.add('hidden');
    dashboardView.classList.remove('hidden');
    
    try {
        const { data: perfil } = await supabaseClient.from('perfiles').select('nombre').eq('id', appState.session.user.id).single();
        if (perfil) userNameDisplay.textContent = `- Bienvenido ${perfil.nombre}`;
    } catch (error) { console.error("Error al obtener perfil:", error); }
    
    await Promise.all([renderLotes(), renderVentas()]);
}

async function renderLotes() {
    try {
        const lotes = await apiFetch('/lotes');
        lotesTableBody.innerHTML = lotes.map(lote => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">${lote.medicamentos.nombre}</td>
                <td class="px-6 py-4">${lote.proveedores.nombre}</td>
                <td class="px-6 py-4">${lote.cantidad_actual}</td>
                <td class="px-6 py-4">${new Date(lote.fecha_vencimiento).toLocaleDateString()}</td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error al cargar lotes:', error);
        lotesTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-500">Error al cargar lotes.</td></tr>`;
    }
}

async function renderVentas() {
    try {
        const ventas = await apiFetch('/ventas');
        salesTableBody.innerHTML = ventas.map(v => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">${new Date(v.fecha).toLocaleString()}</td>
                <td class="px-6 py-4">$${v.total_venta.toFixed(2)}</td>
                <td class="px-6 py-4">${v.clientes ? v.clientes.nombre + ' ' + v.clientes.apellido : 'Público General'}</td>
                <td class="px-6 py-4">${v.perfiles ? v.perfiles.nombre + ' ' + v.perfiles.apellido : 'N/A'}</td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error al cargar ventas:', error);
        salesTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-500">Error al cargar ventas.</td></tr>`;
    }
}

// ============================================================================
// 🔹 5. MODAL FORMS & CRUD OPERATIONS
// ============================================================================
async function showLoteForm() {
    try {
        const [medicamentos, proveedores] = await Promise.all([apiFetch('/medicamentos'), apiFetch('/proveedores')]);
        const medOptions = medicamentos.map(m => `<option value="${m.id}">${m.nombre}</option>`).join('');
        const provOptions = proveedores.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
        
        const formHtml = `
            <select name="medicamento_id" class="w-full p-2 border rounded" required>${medOptions}</select>
            <select name="proveedor_id" class="w-full p-2 border rounded" required>${provOptions}</select>
            <input type="number" name="cantidad_inicial" placeholder="Cantidad Inicial" class="w-full p-2 border rounded" required>
            <input type="number" name="precio_compra" placeholder="Precio de Compra (unitario)" step="0.01" class="w-full p-2 border rounded" required>
            <input type="date" name="fecha_vencimiento" class="w-full p-2 border rounded" required>
            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Añadir Lote</button>
        `;
        showFormModal("Añadir Nuevo Lote (Compra)", formHtml, async (e) => {
            const formData = new FormData(e.target);
            const loteData = Object.fromEntries(formData.entries());
            loteData.cantidad_actual = loteData.cantidad_inicial;
            try {
                await apiFetch('/lotes', { method: 'POST', body: JSON.stringify(loteData) });
                closeModal();
                renderLotes();
            } catch (error) { alert(`Error al crear lote: ${error.message}`); }
        });
    } catch(error) { alert(`Error al preparar formulario: ${error.message}`); }
}

async function showSaleForm() {
    try {
        const [medicamentos, clientes] = await Promise.all([apiFetch('/medicamentos'), apiFetch('/clientes')]);
        const medOptions = medicamentos.map(m => `<option value="${m.id}">${m.nombre}</option>`).join('');
        const clientOptions = clientes.map(c => `<option value="${c.id}">${c.nombre} ${c.apellido} (${c.dni})</option>`).join('');

        const formHtml = `
            <select name="clienteId" class="w-full p-2 border rounded"><option value="">Público General</option>${clientOptions}</select>
            <div id="ventaItems" class="space-y-2 mt-4"></div>
            <button type="button" id="addItemBtn" class="bg-gray-200 p-2 rounded">➕ Añadir Producto</button>
            <button type="submit" class="w-full bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg mt-4">Registrar Venta</button>
        `;

        const onSubmit = async (e) => {
            const ventaData = {
                usuarioId: appState.session.user.id,
                clienteId: e.target.elements.clienteId.value || null,
                items: Array.from(document.querySelectorAll('.venta-item')).map(div => ({
                    medicamentoId: parseInt(div.querySelector('.item-medicamento-id').value),
                    cantidad: parseInt(div.querySelector('.item-cantidad').value),
                    precioUnitario: parseFloat(div.querySelector('.item-precio').value)
                }))
            };
            try {
                await apiFetch('/ventas', { method: 'POST', body: JSON.stringify(ventaData) });
                closeModal();
                renderVentas();
                renderLotes();
            } catch (error) { alert(`Error al registrar venta: ${error.message}`); }
        };

        showFormModal("Registrar Nueva Venta", formHtml, onSubmit);

        const itemsContainer = document.getElementById('ventaItems');
        const addItem = () => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'venta-item flex gap-2 items-center';
            itemDiv.innerHTML = `
                <select class="item-medicamento-id flex-grow p-2 border rounded">${medOptions}</select>
                <input type="number" class="item-cantidad w-20 p-2 border rounded" placeholder="Cant." min="1" required>
                <input type="number" class="item-precio w-24 p-2 border rounded" placeholder="Precio U." step="0.01" required>
                <button type="button" class="removeItemBtn text-red-500">✖️</button>
            `;
            itemsContainer.appendChild(itemDiv);
        };
        addItem();
        document.getElementById('addItemBtn').addEventListener('click', addItem);
        itemsContainer.addEventListener('click', e => {
            if (e.target.classList.contains('removeItemBtn')) e.target.parentElement.remove();
        });
    } catch(error) { alert(`Error al preparar formulario: ${error.message}`); }
}

// ============================================================================
// 🔹 6. APP INITIALIZATION
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
    supabaseClient.auth.onAuthStateChange((_event, session) => {
        appState.session = session;
        updateDashboard();
    });

    loginForm.addEventListener('submit', handleLogin);
    logoutBtn.addEventListener('click', handleLogout);
    showRegisterBtn.addEventListener('click', showRegisterForm);
    addLoteBtn.addEventListener('click', showLoteForm);
    addSaleBtn.addEventListener('click', showSaleForm);
});
</script>

</body>
</html>