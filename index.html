<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Farmacia App v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app" class="w-full h-full max-w-full">
        <div id="loginView" class="hidden">
            <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm mx-auto mt-20">
                <h2 class="text-3xl font-bold text-center text-blue-800 mb-6">Ingreso al Sistema</h2>
                <form id="loginForm" class="space-y-4">
                    <input type="email" id="email" placeholder="Correo Electrónico" class="w-full px-4 py-2 border-2 rounded-lg" required>
                    <input type="password" id="password" placeholder="Contraseña" class="w-full px-4 py-2 border-2 rounded-lg" required>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Ingresar</button>
                </form>
                <p id="errorMsg" class="text-red-500 text-center mt-4"></p>
                <div class="text-center mt-4">
                    <a href="#" id="showRegister" class="text-sm text-blue-600 hover:underline">¿No tienes cuenta? Regístrate</a>
                </div>
            </div>
        </div>

        <div id="dashboardView" class="hidden min-h-screen w-full">
            <header class="bg-blue-800 text-white p-4 shadow-lg flex justify-between items-center">
                <h1 class="text-2xl font-bold">📦 Sistema de Farmacia <span id="userName" class="text-base font-normal"></span></h1>
                <button id="logoutBtn" class="bg-blue-600 hover:bg-blue-500 font-semibold py-2 px-4 rounded-lg">Salir</button>
            </header>

            <main class="p-4 sm:p-8 max-w-7xl mx-auto space-y-8">
                </main>
        </div>
    </div>

    <div id="appModal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-lg w-full transform transition-all scale-95 opacity-0" id="modalContent">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-2xl font-bold text-blue-700"></h3>
                <button onclick="closeModal()" class="text-gray-500 text-3xl hover:text-gray-800">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

<script>
// ============================================================================
// 🔹 1. CONFIGURACIÓN E INICIALIZACIÓN
// ============================================================================
const SUPABASE_URL = 'https://ccfgclymyeciqbgrdfuf.supabase.co'; 
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZmdjbHlteWVjaXFiZ3JkZnVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NTcwODQsImV4cCI6MjA3MjQzMzA4NH0.hN5kiIxFa4FAzsI4UWJGcKQyTTu30dk6M6ybN-PQ2GM';
const API_URL = 'https://farmacia-269414280318.europe-west1.run.app';

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// CORRECCIÓN: Estado global para precargar datos
let appState = { session: null, medicamentos: [], clientes: [] };

const loginView = document.getElementById('loginView');
const dashboardView = document.getElementById('dashboardView');
const mainContent = document.querySelector('#dashboardView main');
const loginForm = document.getElementById('loginForm');
const errorMsg = document.getElementById('errorMsg');
const userNameDisplay = document.getElementById('userName');
const logoutBtn = document.getElementById('logoutBtn');
const showRegisterBtn = document.getElementById('showRegister');
const appModal = document.getElementById('appModal');
const modalContent = document.getElementById('modalContent');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');

// ============================================================================
// 🔹 2. HELPER FUNCTIONS
// ============================================================================
async function apiFetch(endpoint, options = {}) {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) throw new Error("No estás autenticado.");
    const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` };
    const finalUrl = `${API_URL.replace(/\/$/, '')}/${endpoint.replace(/^\//, '')}`;
    const response = await fetch(finalUrl, { ...options, headers: { ...headers, ...options.headers } });
    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Error de la API (${response.status}): ${errorText}`);
    }
    const contentType = response.headers.get("content-type");
    if (contentType?.includes("application/json")) return response.json();
    return {};
}

const showModal = () => {
    appModal.classList.remove('hidden');
    setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 10);
};
const closeModal = () => {
    modalContent.classList.add('scale-95', 'opacity-0');
    setTimeout(() => appModal.classList.add('hidden'), 300);
};
const showFormModal = (title, formHtml, onSubmit) => {
    modalTitle.textContent = title;
    const form = document.createElement('form');
    form.className = 'space-y-4';
    form.innerHTML = formHtml;
    form.onsubmit = (e) => { e.preventDefault(); onSubmit(e); };
    modalBody.innerHTML = '';
    modalBody.appendChild(form);
    showModal();
};
window.closeModal = closeModal;

// ============================================================================
// 🔹 3. AUTHENTICATION
// ============================================================================
async function handleLogin(e) {
    e.preventDefault();
    errorMsg.textContent = '';
    const { email, password } = Object.fromEntries(new FormData(e.target));
    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if (error) errorMsg.textContent = 'Credenciales incorrectas.';
}
async function handleSignUp(e) {
    const { email, password, nombre, apellido, dni } = Object.fromEntries(new FormData(e.target));
    const { error } = await supabaseClient.auth.signUp({ email, password, options: { data: { nombre, apellido, dni } } });
    closeModal();
    if (error) alert(`Error en el registro: ${error.message}`);
    else alert('Registro Exitoso. Revisa tu correo para la confirmación.');
}
async function handleLogout() {
    await supabaseClient.auth.signOut();
}
function showRegisterForm() {
    const formHtml = `
        <input type="text" name="nombre" placeholder="Nombre" class="w-full px-4 py-2 border rounded" required>
        <input type="text" name="apellido" placeholder="Apellido" class="w-full px-4 py-2 border rounded" required>
        <input type="text" name="dni" placeholder="DNI" class="w-full px-4 py-2 border rounded" required>
        <input type="email" name="email" placeholder="Correo Electrónico" class="w-full px-4 py-2 border rounded" required>
        <input type="password" name="password" placeholder="Contraseña (mín. 6 caracteres)" class="w-full px-4 py-2 border rounded" required>
        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded">Registrar</button>`;
    showFormModal("Registro de Nuevo Usuario", formHtml, handleSignUp);
}

// ============================================================================
// 🔹 4. UI & DATA RENDERING
// ============================================================================
async function updateDashboard() {
    if (!appState.session) {
        loginView.classList.remove('hidden');
        dashboardView.classList.add('hidden');
        return;
    }
    loginView.classList.add('hidden');
    dashboardView.classList.remove('hidden');
    
    try {
        const { data: perfil } = await supabaseClient.from('perfiles').select('nombre').eq('id', appState.session.user.id).single();
        if (perfil) userNameDisplay.textContent = `- Bienvenido ${perfil.nombre}`;

        // CORRECCIÓN: Precargar todos los datos necesarios para el dashboard
        [appState.medicamentos, appState.clientes] = await Promise.all([
            apiFetch('/medicamentos'),
            apiFetch('/clientes')
        ]);

        renderDashboardSections();
        renderLotes();
        renderVentas();
    } catch (error) { 
        console.error("Error al cargar datos del dashboard:", error);
        mainContent.innerHTML = `<p class="text-red-500 text-center">No se pudieron cargar los datos. Por favor, recarga la página.</p>`;
    }
}

function renderDashboardSections() {
    mainContent.innerHTML = `
        <section id="lotesSection" class="bg-white p-6 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-blue-700">Lotes de Inventario</h2>
                <button id="addLoteBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">📦 Añadir Lote (Compra)</button>
            </div>
            <div class="overflow-x-auto rounded-lg border">
                <table class="min-w-full divide-y"><thead class="bg-gray-50"><tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Medicamento</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Proveedor</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cant. Actual</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vencimiento</th>
                </tr></thead><tbody id="lotesTableBody" class="bg-white divide-y"></tbody></table>
            </div>
        </section>
        <section id="ventasSection" class="bg-white p-6 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-blue-700">Ventas</h2>
                <button id="addSaleBtn" class="bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">🛒 Nueva Venta</button>
            </div>
            <div class="overflow-x-auto rounded-lg border">
                <table class="min-w-full divide-y"><thead class="bg-gray-50"><tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Atendido por</th>
                </tr></thead><tbody id="salesTableBody" class="bg-white divide-y"></tbody></table>
            </div>
        </section>`;
    // Reconectar botones después de redibujar
    document.getElementById('addLoteBtn').addEventListener('click', showLoteForm);
    document.getElementById('addSaleBtn').addEventListener('click', showSaleForm);
}

async function renderLotes() {
    const lotesTableBody = document.getElementById('lotesTableBody');
    try {
        const lotes = await apiFetch('/lotes');
        lotesTableBody.innerHTML = lotes.map(l => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">${l.medicamentos.nombre}</td>
                <td class="px-6 py-4">${l.proveedores.nombre}</td>
                <td class="px-6 py-4">${l.cantidad_actual}</td>
                <td class="px-6 py-4">${new Date(l.fecha_vencimiento).toLocaleDateString()}</td>
            </tr>`).join('') || `<tr><td colspan="4" class="p-4 text-center">No hay lotes en inventario.</td></tr>`;
    } catch (error) {
        lotesTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Error al cargar lotes.</td></tr>`;
    }
}

async function renderVentas() {
    const salesTableBody = document.getElementById('salesTableBody');
    try {
        const ventas = await apiFetch('/ventas');
        salesTableBody.innerHTML = ventas.map(v => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">${new Date(v.fecha).toLocaleString()}</td>
                <td class="px-6 py-4">$${v.total_venta.toFixed(2)}</td>
                <td class="px-6 py-4">${v.clientes ? v.clientes.nombre + ' ' + v.clientes.apellido : 'Público General'}</td>
                <td class="px-6 py-4">${v.perfiles ? v.perfiles.nombre + ' ' + v.perfiles.apellido : 'N/A'}</td>
            </tr>`).join('') || `<tr><td colspan="4" class="p-4 text-center">No hay ventas registradas.</td></tr>`;
    } catch (error) {
        salesTableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Error al cargar ventas.</td></tr>`;
    }
}

// ============================================================================
// 🔹 5. MODAL FORMS & CRUD OPERATIONS
// ============================================================================
function showLoteForm() { /* Lógica para añadir lote */ }

// CORRECCIÓN: La función ahora lee los datos desde appState
function showSaleForm() {
    const { medicamentos, clientes } = appState;

    if (medicamentos.length === 0) {
        alert("La lista de medicamentos aún no se ha cargado. Por favor, espera un momento o recarga la página.");
        return;
    }

    const medOptions = medicamentos.map(m => `<option value="${m.id}" data-precio="${m.precio_venta}">${m.nombre}</option>`).join('');
    const clientOptions = clientes.map(c => `<option value="${c.id}">${c.nombre} ${c.apellido} (${c.dni})</option>`).join('');

    const formHtml = `
        <select name="clienteId" class="w-full p-2 border rounded"><option value="">Público General</option>${clientOptions}</select>
        <div id="ventaItems" class="space-y-2 mt-4"></div>
        <button type="button" id="addItemBtn" class="bg-gray-200 p-2 rounded">➕ Añadir Producto</button>
        <button type="submit" class="w-full bg-yellow-600 text-white font-bold py-2 px-4 rounded mt-4">Registrar Venta</button>`;

    const onSubmit = async (e) => {
        const ventaData = {
            usuarioId: appState.session.user.id,
            clienteId: e.target.elements.clienteId.value || null,
            items: Array.from(document.querySelectorAll('.venta-item')).map(div => ({
                medicamentoId: parseInt(div.querySelector('.item-medicamento-id').value),
                cantidad: parseInt(div.querySelector('.item-cantidad').value)
            }))
        };
        try {
            await apiFetch('/ventas', { method: 'POST', body: JSON.stringify(ventaData) });
            closeModal();
            // Refrescar los datos después de la venta
            renderVentas();
            renderLotes();
        } catch (error) { alert(`Error al registrar venta: ${error.message}`); }
    };

    showFormModal("Registrar Nueva Venta", formHtml, onSubmit);

    const itemsContainer = document.getElementById('ventaItems');
    const addItem = () => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'venta-item flex gap-2 items-center';
        itemDiv.innerHTML = `
            <select class="item-medicamento-id flex-grow p-2 border rounded">${medOptions}</select>
            <input type="number" class="item-cantidad w-20 p-2 border rounded" placeholder="Cant." min="1" required>
            <input type="number" class="item-precio w-24 p-2 border rounded bg-gray-100" placeholder="Precio U." step="0.01" readonly>
            <button type="button" class="removeItemBtn text-red-500">✖️</button>`;
        itemsContainer.appendChild(itemDiv);
    };
    addItem(); // Añadir el primer item por defecto
    
    // Auto-rellenar precio para el primer item
    const firstSelect = itemsContainer.querySelector('.item-medicamento-id');
    if(firstSelect.options.length > 0) {
        const firstPrice = firstSelect.options[firstSelect.selectedIndex].dataset.precio;
        itemsContainer.querySelector('.item-precio').value = firstPrice || '0.00';
    }

    document.getElementById('addItemBtn').addEventListener('click', addItem);
    itemsContainer.addEventListener('click', e => {
        if (e.target.classList.contains('removeItemBtn')) e.target.parentElement.remove();
    });
    itemsContainer.addEventListener('change', e => {
        if (e.target.classList.contains('item-medicamento-id')) {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const precioInput = e.target.closest('.venta-item').querySelector('.item-precio');
            precioInput.value = selectedOption.dataset.precio || '0.00';
        }
    });
}

// ============================================================================
// 🔹 6. APP INITIALIZATION
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
    supabaseClient.auth.onAuthStateChange((_event, session) => {
        appState.session = session;
        updateDashboard();
    });

    loginForm.addEventListener('submit', handleLogin);
    logoutBtn.addEventListener('click', handleLogout);
    showRegisterBtn.addEventListener('click', showRegisterForm);
});
</script>

</body>
</html>